# DiceGameServer

多人色子游戏的服务端

Maven构建，Dao层使用MyBatis，MySql数据库

核心是**Socket**

> 服务端需要做数据解析，存储，向客户端发送。

# 功能

`目前完成了注册、登录、头像修改功能的服务。`

每个服务分别监听对应端口的连接，并通过套接字获取信息，再和数据库核对后回送响应给客户端。

## 注册（TCP）

注册时会包含部分敏感信息，因此使用长连接的TCP。

循环监听`REGISTER_SERVER_PORT`端口，获取到连接后提交任务线程到任务线程池中。

任务线程从流中获取注册信息，在数据库中校验，并存入数据库，最后向客户端回送仅1字节的注册结果。

结果对应的回应：1：成功，2：异常（已存在该用户），0：失败（几乎不会发生，通常是数据库问题）

通讯内容约定：

1. 服务端接收：客户端连接后需要向服务端发送8个字节长度的注册信息（JSON格式的User对象）字节数，服务端根据此字节数来获取接下来的数据，不会获取后面的数据。
2. 服务端响应：服务端仅响应1字节的注册结果。



## 登录（UDP）

登录时不会包含敏感信息，因此使用速度更快的UDP。

循环监听`LOGIN_SERVER_PORT`端口，获取到数据包后提交任务线程到任务线程池中。

任务线程从数据包中获取数据（经过MD5加盐加密，32位，后面称为用户校验字段），使用此数据作为密码字段查询数据库是否存在该用户，最终通过`UDP_REPLY_PORT`端口向客户端回送脱敏后的User对象的JSON字符串数据包。

响应约定：

​	失败：即未找到该用户，回送一个没有属性的User对象。

​	成功：回送一个包含用户id、头像url、昵称的User对象。



## 修改头像（TCP）

修改头像需要发送文件，因此使用TCP。

循环监听`FILE_SERVER_PORT`端口，获取到连接后提交任务线程到任务线程池中。

任务线程处理流程：

1. 从流中读取32字节的用户校验字段，
2. 验证该用户是否存在（目的并不是为了安全之类的，而是拿到该用户对象，如果拿不到则直接关流结束，此处设计时没有考虑过用户不存在的问题）。
3. 生成随机文件名，
4. 从流中读取8位文件大小数据
5. 将头像文件写入`USER_ICON_FOLDER_PATH`目录下（此目录是Tomcat的文件服务的目录）
6. 生成头像文件的URL
7. 更新数据库中的用户数据
8. 向客户端响应0

此功能有很多缺陷，如用户验证失败的响应，原头像文件的删除等。



## 游戏过程

开发中...



## 排行榜

开发中...



## 战绩查询

开发中...



&copy;Write By flyOnUiThread

